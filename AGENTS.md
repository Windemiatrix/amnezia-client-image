# AGENTS.md — amnedia-client-image

## Цель проекта

Создать Docker-образ клиента AmneziaWG VPN. Образ должен запускать AmneziaWG-пир (клиент) в контейнере и подходить для развёртывания в Docker, Docker Compose, Kubernetes и Home Assistant. Ядро хоста не содержит модуль AmneziaWG, поэтому используется userspace-реализация на Go.

## Upstream-зависимости

Проект не содержит собственного VPN-кода. Всё берётся из двух upstream-репозиториев:

1. **amneziawg-go** — `https://github.com/amnezia-vpn/amneziawg-go`
   Userspace-реализация AmneziaWG на Go. Компилируется в статический бинарник, который работает как VPN-демон в пространстве пользователя через TUN-интерфейс.

2. **amneziawg-tools** — `https://github.com/amnezia-vpn/amneziawg-tools`
   CLI-утилиты для управления интерфейсами: `awg` (аналог `wg`) и `awg-quick` (аналог `wg-quick`). Собираются из C-исходников через `make && make install`.

## Runtime-требования контейнера

Эти параметры обязательны при запуске, без них VPN не заработает:

| Параметр    | Значение                             | Зачем                                                       |
| ----------- | ------------------------------------ | ----------------------------------------------------------- |
| `--device`  | `/dev/net/tun:/dev/net/tun`          | TUN-устройство для VPN-туннеля                              |
| `--cap-add` | `NET_ADMIN`                          | Управление сетевыми интерфейсами и iptables                 |
| `--cap-add` | `SYS_MODULE`                         | Загрузка модулей ядра (опционально)                         |
| `--sysctl`  | `net.ipv4.conf.all.src_valid_mark=1` | Корректная маршрутизация с fwmark                           |
| `--sysctl`  | `net.ipv4.ip_forward=1`              | Форвардинг трафика (нужен если контейнер на отдельной сети) |
| `-v`        | `/path/to/configs:/config`           | Директория с `.conf`-файлами AmneziaWG                      |

### Формат конфигурации

Пользователь монтирует том `/config` с одним или несколькими `.conf`-файлами формата AmneziaWG (расширение формата WireGuard с дополнительными параметрами обфускации). Имя файла определяет имя сетевого интерфейса: `wg0.conf` → интерфейс `wg0`.

## Безопасность

- `.conf`-файлы содержат приватные ключи — **никогда не коммитить в репозиторий**. Добавить `*.conf` в `.gitignore`.
- Внутри контейнера конфиги копируются с правами `600`.
- Образ работает от root — это необходимо для `NET_ADMIN` и управления интерфейсами.

## Makefile

Проект использует `Makefile` как единую точку входа для всех операций. Вызов `make help` выводит список доступных целей с описаниями.

### Target `help` (самодокументирование)

Target `help` — первый в файле (вызывается по умолчанию при `make` без аргументов). Он парсит сам `Makefile` через `awk` и выводит отформатированный список целей.

**Полная команда `help` (копировать as-is, включая табуляцию перед `@awk`):**

```makefile
.PHONY: help
help: ## Display this help.
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make \033[36m<target>\033[0m\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)
```

**Как это работает:**

- `FS = ":.*##"` — разделитель: всё между `:` и `##`. Первое поле (`$$1`) — имя target, второе (`$$2`) — описание после `##`.
- `/^[a-zA-Z_0-9-]+:.*?##/` — матчит строки вида `target: [deps] ## Описание` и выводит target циановым цветом, описание — рядом.
- `/^##@/` — матчит строки-заголовки секций вида `##@ Название` и выводит их жирным шрифтом как разделители.
- `$(MAKEFILE_LIST)` — парсит сам себя (и включённые файлы).

**Правила оформления targets, чтобы `make help` работал корректно:**

1. **Описываемые targets** — добавлять `## Описание` через пробел после зависимостей:
   ```makefile
   build: ## Build Docker image
   test: build ## Build and verify image
   ```
2. **Служебные targets** (не должны попадать в help) — НЕ добавлять `##`:
   ```makefile
   wait:
   	sleep 1
   ```
3. **Заголовки секций** — строка, начинающаяся с `##@`:
   ```makefile
   ##@ Build
   ##@ Test
   ##@ Clean
   ```
4. **Имена targets** — только `[a-zA-Z_0-9-]`, без точек и слешей, иначе awk-паттерн их не подхватит.
5. **Отступы в рецептах** — строго табуляция (не пробелы), это требование `make`.

### Соглашения

- Каждый target объявляется `.PHONY`.
- Переменные задаются через `?=` (можно переопределить из окружения или `.env`).
- Файл `.env` подключается через `include .env` с предварительным `touch` (чтобы не падать при отсутствии файла):
  ```makefile
  dummy := $(shell touch .env)
  include .env
  export
  ```

## Стиль кода и коммитов

- Формат коммитов: `<тип>: <описание>` (`fix:`, `feat:`, `docs:`, `chore:`).
- Перед коммитом проверить, что образ собирается.
- Не коммитить файлы с секретами.
